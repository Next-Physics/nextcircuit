<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>NextCircuit</title>

  <!-- Use a clean, modern, timeless font from Google Fonts (Inter) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      /* Color Palette */
      --background-color: #1e1e1e;
      --sidebar-color: #242424;
      --sidebar-border-color: #333;
      --panel-color: #2a2a2a;
      --panel-border-color: #3a3a3a;
      --text-color: #eaeaea;
      --text-muted-color: #aaaaaa;
      --accent-color: #3b82f6;   /* Blue for normal actions */
      --accent-hover: #2563eb;  /* Darker blue on hover */
      --danger-color: #ef4444;  /* Red for destructive/stop */
      --danger-hover: #dc2626;  /* Darker red on hover */
      --success-color: #00c853; /* Green for success (progress fill) */
      --warning-color: #f1c40f; /* Yellowish for elaborating steps */
      --scrollbar-track: #333;
      --scrollbar-thumb: #555;
      --font-main: "Inter", sans-serif;
      --font-size-base: 14px;
      --font-size-sm: 13px;
      --font-size-md: 15px;
      --font-size-lg: 16px;
      --border-radius: 6px;
    }

    /* RESET / BASE */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: var(--font-main);
      font-size: var(--font-size-base);
      background-color: var(--background-color);
      color: var(--text-color);
      overflow: hidden;
    }

    /* CONTAINER LAYOUT */
    .container {
      display: grid;
      grid-template-columns: 280px 1fr 280px;  /* left sidebar, main, right sidebar */
      grid-template-rows: 1fr;
      height: 100%;
      max-height: 100%;
      position: relative;
      gap: 0;
    }

    /* LEFT SIDEBAR */
    .sidebar {
      background: var(--sidebar-color);
      padding: 15px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      border-right: 1px solid var(--sidebar-border-color);
    }
    .sidebar h3 {
      margin-top: 20px;
      margin-bottom: 15px;
      font-weight: 500;
      font-size: var(--font-size-md);
    }
    .sidebar-top {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .sidebar-top button {
      background: var(--accent-color);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: background 0.2s;
      width: 100%;
    }
    .sidebar-top button:hover {
      background: var(--accent-hover);
    }

    /* Past Conversations List */
    #conversations_list p {
      font-size: var(--font-size-sm);
      color: var(--text-muted-color);
    }
    .conversation-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #2f2f2f;
      border-radius: var(--border-radius);
      padding: 8px;
      margin-bottom: 8px;
      transition: background 0.2s;
      font-size: var(--font-size-sm);
      line-height: 1.4em;
      word-wrap: break-word;
      cursor: pointer;
    }
    .conversation-item:hover {
      background: #3c3c3c;
    }
    .conversation-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .delete-conversation {
      margin-left: 10px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    .delete-conversation:hover {
      opacity: 1;
    }

    /* MAIN AREA */
    .main {
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 15px;
      overflow: hidden;
      background: var(--panel-color);
      border-right: 1px solid var(--panel-border-color);
    }

    /* Title of the Conversation */
    .conversation-title-text {
      font-weight: 600;
      font-size: var(--font-size-md);
      margin-bottom: 10px;
      color: #fff;
    }

    /* TOP BAR (user input, mode selection, etc.) */
    .top-bar {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    #user_query {
      flex: 2;
      min-width: 180px;
      font-size: var(--font-size-sm);
    }
    .top-bar input[type="text"],
    .top-bar select {
      background: #3a3a3a;
      border: 1px solid #555;
      border-radius: var(--border-radius);
      padding: 6px 8px;
      font-size: var(--font-size-sm);
      color: var(--text-color);
    }
    .top-bar input::placeholder {
      color: var(--text-muted-color);
    }
    .top-bar select {
      color: var(--text-color);
      cursor: pointer;
    }
    .top-bar button {
      background: var(--accent-color);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: background 0.2s;
    }
    .top-bar button:hover {
      background: var(--accent-hover);
    }
    .top-bar .stop-button {
      background: var(--danger-color);
    }
    .top-bar .stop-button:hover {
      background: var(--danger-hover);
    }
    .top-bar .timer {
      font-size: var(--font-size-sm);
      color: var(--text-muted-color);
      margin-left: auto;
      white-space: nowrap;
    }

    /* FILE ATTACHMENTS SECTION */
    .file-attachments {
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .file-attachments-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .file-attachments-header button {
      background: var(--accent-color);
      padding: 6px 10px;
      border: none;
      border-radius: var(--border-radius);
      font-size: var(--font-size-sm);
      cursor: pointer;
      color: #fff;
      transition: background 0.2s;
    }
    .file-attachments-header button:hover {
      background: var(--accent-hover);
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #333;
      border: 1px solid #555;
      border-radius: var(--border-radius);
      padding: 7px;
      font-size: var(--font-size-sm);
    }
    .file-item input[type="text"] {
      flex: 1;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 4px;
      font-size: var(--font-size-sm);
      background: #2f2f2f;
      color: var(--text-color);
    }
    .file-item .remove-file {
      cursor: pointer;
      background: var(--danger-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: var(--font-size-sm);
      transition: background 0.2s;
    }
    .file-item .remove-file:hover {
      background: var(--danger-hover);
    }
    /* Static display (read-only) of files */
    .static-file {
      flex-direction: column;
      align-items: flex-start;
      padding: 6px;
      background: #2f2f2f;
      border: 1px solid #444;
      border-radius: var(--border-radius);
      margin-bottom: 8px;
    }
    .static-file span {
      font-size: var(--font-size-sm);
      color: var(--text-muted-color);
    }

    /* SPLIT VIEW: OUTPUT AREA + RESULTS + PROGRESS BAR */
    .split-view {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      gap: 10px;
    }

    /* MAIN CONVERSATION OUTPUT (lots of text) */
    .output-area {
      flex: 2;
      background: #1e1e1e;
      border: 1px solid #444;
      border-radius: var(--border-radius);
      padding: 15px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: "Inter", sans-serif; /* easy-to-read text for conversation */
      font-size: var(--font-size-md);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
      line-height: 1.4em;
    }

    /* RESULTS BOX */
    .results-box {
      flex: 0.5;
      background: #1e1e1e;
      border: 1px solid #444;
      border-radius: var(--border-radius);
      padding: 15px;
      overflow-y: auto;
      font-family: "Inter", sans-serif;
      font-size: var(--font-size-sm);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
    }
    .results-box h4 {
      margin-top: 0;
      font-size: var(--font-size-md);
      margin-bottom: 10px;
    }
    .results-list {
      list-style: none;
      padding: 0;
      margin: 0;
      column-count: 2;
      column-gap: 10px;
    }
    .results-list li {
      padding: 5px 0;
      border-bottom: 1px solid #333;
      font-size: var(--font-size-sm);
      word-wrap: break-word;
      break-inside: avoid;
    }

    /* OVERALL PROGRESS (below results) */
    .overall-progress {
      margin-top: auto;
    }
    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: var(--font-size-sm);
      color: var(--text-muted-color);
    }
    .overall-progress-bar {
      width: 100%;
      background-color: #333;
      border-radius: var(--border-radius);
      overflow: hidden;
      height: 20px;
      position: relative;
    }
    .overall-progress-fill {
      height: 100%;
      background-color: var(--success-color);
      width: 0%;
      transition: width 0.5s ease-in-out;
    }

    /* PROGRESS BAR AT BOTTOM (MAIN) */
    #main_progress_bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: #333;
      overflow: hidden;
      display: none;
    }
    #main_progress_bar_fill {
      position: absolute;
      width: 100%;
      height: 100%;
      background: var(--accent-color);
      animation: slowTravel 5s linear infinite;
    }
    @keyframes slowTravel {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }

    /* RIGHT SIDEBAR: PLAN STEPS */
    .sidebar-right {
      background: var(--sidebar-color);
      border-left: 1px solid var(--sidebar-border-color);
      padding: 15px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .sidebar-right h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-weight: 500;
      color: #fff;
      font-size: var(--font-size-md);
    }
    .plan-step {
      background: #2f2f2f;
      border: 1px solid #444;
      border-radius: var(--border-radius);
      margin-bottom: 10px;
      padding: 10px;
      font-size: var(--font-size-sm);
      display: flex;
      flex-direction: column;
      gap: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .plan-step:hover {
      background: #3b3b3b;
    }
    .plan-step-header {
      display: flex;
      align-items: center;
      font-weight: 500;
    }
    .step-icon {
      font-size: var(--font-size-md);
      margin-right: 5px;
    }
    .awaiting-plan {
      font-size: var(--font-size-sm);
      color: var(--text-muted-color);
      font-style: italic;
    }

    /* SCROLLBARS (dark style) */
    .output-area,
    .results-box,
    .sidebar,
    .sidebar-right {
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
    }
    .output-area::-webkit-scrollbar,
    .results-box::-webkit-scrollbar,
    .sidebar::-webkit-scrollbar,
    .sidebar-right::-webkit-scrollbar {
      width: 8px;
    }
    .output-area::-webkit-scrollbar-thumb,
    .results-box::-webkit-scrollbar-thumb,
    .sidebar::-webkit-scrollbar-thumb,
    .sidebar-right::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 4px;
    }
    .output-area::-webkit-scrollbar-track,
    .results-box::-webkit-scrollbar-track,
    .sidebar::-webkit-scrollbar-track,
    .sidebar-right::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
    }

    /* RESPONSIVE BREAKPOINT */
    @media (max-width: 992px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      .sidebar {
        grid-row: 1;
      }
      .main {
        grid-row: 2;
      }
      .sidebar-right {
        grid-row: 3;
        flex-direction: row;
        flex-wrap: wrap;
        overflow-x: auto;
        padding: 10px;
        border-top: 1px solid var(--sidebar-border-color);
        border-left: none;
      }
    }

    /* MODAL (DELETE CONFIRMATION) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-box {
      background: #2c2c2c;
      padding: 20px;
      border-radius: var(--border-radius);
      max-width: 300px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      text-align: center;
      border: 1px solid #444;
    }
    .modal-box h4 {
      margin-top: 0;
      font-weight: 500;
      font-size: var(--font-size-md);
      color: #fff;
    }
    .modal-box p {
      font-size: var(--font-size-sm);
      color: var(--text-color);
    }
    .modal-actions {
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
    }
    .modal-actions button {
      padding: 8px 12px;
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: background 0.2s;
    }
    .modal-actions .cancel-btn {
      background: #555;
      color: #fff;
    }
    .modal-actions .cancel-btn:hover {
      background: #666;
    }
    .modal-actions .delete-btn {
      background: var(--danger-color);
      color: #fff;
    }
    .modal-actions .delete-btn:hover {
      background: var(--danger-hover);
    }

    /* STEP DETAIL POPUP */
    .step-detail-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9000;
    }
    .step-detail-overlay.active {
      display: flex;
    }
    .step-detail-box {
      background: #2c2c2c;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      color: var(--text-color);
      position: relative;
      max-height: 87vh;
      width: 90%;
      max-width: 600px;
      overflow-y: auto;
      padding: 0px;
      border: 1px solid #444;
      display: flex;
      flex-direction: column; /* Ensure proper layout */
    }

    /* Header Container */
    .step-detail-header {
      position: sticky;
      top: 0;
      background: #2c2c2c;
      padding: 20px 20px 10px 20px; /* Top, Right, Bottom, Left */
      z-index: 3;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Title Styling */
    .step-detail-header h4 {
      margin: 0;
      font-size: var(--font-size-md);
      color: #fff;
    }

    /* Close Button Styling */
    .step-detail-header .close-btn {
      background: transparent;
      border: none;
      font-size: var(--font-size-lg);
      cursor: pointer;
      color: #aaa;
      transition: color 0.2s;
    }

    .step-detail-header .close-btn:hover {
      color: #fff;
    }

    .step-detail-box .step-detail-body {
      padding: 20px;
      margin-top: 0px;
      font-size: var(--font-size-sm);
      text-align: left;
      color: var(--text-color);
      white-space: normal;
      word-break: break-word;
    }

    .step-detail-box .step-detail-body pre,
    .step-detail-box .step-detail-body code {
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- LEFT SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-top">
        <button onclick="newAgent()">New Agent</button>
      </div>
      <h3>Past Conversations</h3>
      <div id="conversations_list">
        {% if conversations %}
          {% for conv in conversations %}
            <div class="conversation-item" data-chain-id="{{ conv.id }}">
              <div class="conversation-title" onclick="loadConversation('{{ conv.id }}')">
                {{ conv.title if conv.title else '' }} | {{ conv.id }}
              </div>
              <div class="delete-conversation" onclick="promptDeleteConversation(event, '{{ conv.id }}')">🗑️</div>
            </div>
          {% endfor %}
        {% else %}
          <p>No past conversations found.</p>
        {% endif %}
      </div>
    </div>

    <!-- MAIN AREA -->
    <div class="main">
      <div id="conversation_title" class="conversation-title-text"></div>

      <div class="top-bar">
        <select id="mode_select" onchange="toggleModeFields()">
          <option value="ollama">Ollama</option>
          <option value="chatgpt">ChatGPT</option>
        </select>

        <!-- Ollama Fields -->
        <div id="ollama_fields" style="display:flex;">
          <input type="text" id="ollama_ip" placeholder="Ollama IP" style="width:100px; margin-right:10px;" />
          <input type="text" id="ollama_port" placeholder="Port" style="width:60px; margin-right:10px;" />
          <select id="ollama_model" style="min-width:140px;">
            <option value="mannix/llama3.1-8b-abliterated">mannix/llama3.1-8b-abliterated</option>
            <option value="llama3.1:8b">llama3.1:8b</option>
            <option value="llama3.2">llama3.2</option>
            <option value="llama3.2:1b">llama3.2:1b</option>
          </select>
        </div>

        <!-- ChatGPT Fields -->
        <div id="chatgpt_fields" style="display:none;">
          <input
            type="text"
            id="chatgpt_api_key"
            placeholder="API Key"
            style="width:180px;"
          />
          <select id="chatgpt_model" style="min-width:120px;">
            <option value="gpt-4o-2024-11-20">GPT 4o</option>
            <option value="gpt-4o-mini-2024-07-18">GPT 4o Mini</option>
          </select>
        </div>

        <input type="text" id="user_query" placeholder="Enter your query..." />
        <button id="start_agent_btn" onclick="startAgent()">Start Agent</button>
        <button
          id="stop_agent_btn"
          class="stop-button"
          onclick="stopAgent()"
          style="display:none;"
        >
          Stop Agent
        </button>

        <div class="timer">
          Time running: <span id="timer_value">00:00:00</span>
        </div>
      </div>

      <!-- FILE ATTACHMENTS -->
      <div class="file-attachments">
        <div class="file-attachments-header">
          <button id="add_file_btn" onclick="triggerFileSelect()">Add File</button>
          <input
            type="file"
            id="file_input"
            style="display:none;"
            onchange="uploadSelectedFile(event)"
            multiple
          />
        </div>
        <div id="attached_files_container"></div>
      </div>

      <!-- SPLIT VIEW -->
      <div class="split-view">
        <div class="output-area" id="output_area"></div>
        <div class="results-box">
          <h4>Results</h4>
          <ul class="results-list" id="results_list"></ul>
        </div>

        <!-- OVERALL PROGRESS -->
        <div class="overall-progress">
          <div class="progress-info">
            <span id="progress_pct">0%</span>
            <span id="progress_stage">Not started</span>
          </div>
          <div class="overall-progress-bar" id="overall_progress_bar">
            <div class="overall-progress-fill" id="overall_progress_fill"></div>
          </div>
        </div>
      </div>

      <div id="main_progress_bar">
        <div id="main_progress_bar_fill"></div>
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="sidebar-right">
      <h3>Plan Steps</h3>
      <div id="plan_steps_container"></div>
    </div>
  </div>

  <!-- STEP DETAIL MODAL -->
  <div class="step-detail-overlay" id="step_detail_overlay">
    <div class="step-detail-box">
      <div class="step-detail-header">
        <h4 id="step_detail_title">Step Title</h4>
        <button class="close-btn" onclick="closeStepDetail()">✕</button>
      </div>
      <div class="step-detail-body" id="step_detail_body"></div>
    </div>
  </div>

  <!-- DELETE MODAL -->
  <div class="modal-overlay" id="delete_modal">
    <div class="modal-box">
      <h4>Delete Conversation?</h4>
      <p>Are you sure you want to delete this conversation?</p>
      <div class="modal-actions">
        <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
        <button class="delete-btn" onclick="deleteConversationConfirmed()">Delete</button>
      </div>
    </div>
  </div>

  <!-- All business logic preserved below -->
  <script>
    let eventSource = null;
    let timerInterval = null;
    let startTime = null;
    let attachedFiles = [];
    let chainIdToDelete = null;
    let agentRunning = false;
    let initialConversations = [];
    let activeChainId = null;
    let planInterval = null;
    let titleInterval = null;
    let conversationInterval = null;
    let progressInterval = null;
    let agentEverStarted = false;
    let folderRenamed = false;

    let lastPlanData = null;

    document.addEventListener("DOMContentLoaded", function () {
      // load saved config from localStorage
      const savedIp = localStorage.getItem("ollama_ip");
      const savedPort = localStorage.getItem("ollama_port");
      const savedApiKey = localStorage.getItem("chatgpt_api_key");
      const savedModel = localStorage.getItem("chatgpt_model");
      const savedOllamaModel = localStorage.getItem("ollama_model");

      if (savedIp) document.getElementById("ollama_ip").value = savedIp;
      if (savedPort) document.getElementById("ollama_port").value = savedPort;
      if (savedOllamaModel)
        document.getElementById("ollama_model").value = savedOllamaModel;

      if (savedApiKey) document.getElementById("chatgpt_api_key").value = savedApiKey;
      if (savedModel) document.getElementById("chatgpt_model").value = savedModel;

      initialConversations = getCurrentConversationIds();
      updateStartButtonLabel();
    });

    function updateStartButtonLabel() {
      const btn = document.getElementById("start_agent_btn");
      btn.textContent = agentEverStarted ? "Continue Agent" : "Start Agent";
    }

    function getCurrentConversationIds() {
      const items = document.querySelectorAll(".conversation-item[data-chain-id]");
      return Array.from(items).map((i) => i.getAttribute("data-chain-id"));
    }

    function newAgent() {
      document.getElementById("output_area").textContent = "";
      document.getElementById("user_query").value = "";
      document.getElementById("user_query").disabled = false;
      attachedFiles = [];
      stopAgentIfRunning();
      showStartButton();
      resetTimer();
      renderPlanSteps([]);
      activeChainId = null;
      document.getElementById("results_list").innerHTML = "";
      document.getElementById("conversation_title").textContent = "";
      lastPlanData = null;
      agentEverStarted = false;
      folderRenamed = false;

      updateStartButtonLabel();
      resetProgressIndicators();

      // Make attachments editable again
      setFileAttachmentsEditable(true);
      renderAttachedFiles();
    }

    function resetProgressIndicators() {
      document.getElementById("progress_pct").textContent = "0%";
      document.getElementById("progress_stage").textContent = "Not started";
      document.getElementById("overall_progress_fill").style.width = "0%";
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
    }

    function toggleModeFields() {
      const mode = document.getElementById("mode_select").value;
      if (mode === "ollama") {
        document.getElementById("ollama_fields").style.display = "flex";
        document.getElementById("chatgpt_fields").style.display = "none";
      } else {
        document.getElementById("ollama_fields").style.display = "none";
        document.getElementById("chatgpt_fields").style.display = "flex";
      }
    }

    function triggerFileSelect() {
      document.getElementById("file_input").click();
    }

    // Upload multiple files
    function uploadSelectedFile(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        const formData = new FormData();
        formData.append("file", file);

        fetch("/upload_file", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "ok") {
              const filename = data.path;
              attachedFiles.push({
                [filename]: {
                  description: "",
                },
              });
              renderAttachedFiles();
            } else {
              alert("File upload failed: " + data.message);
            }
          })
          .catch((err) => {
            console.error("Upload error:", err);
            alert("File upload failed.");
          });
      }
      event.target.value = "";
    }

    function renderAttachedFiles() {
      const attachedFilesContainer = document.getElementById("attached_files_container");
      attachedFilesContainer.innerHTML = "";

      attachedFiles.forEach((fileObj, index) => {
        const filename = Object.keys(fileObj)[0];
        const description = fileObj[filename].description;

        const div = document.createElement("div");
        div.className = "file-item";

        const fileNameSpan = document.createElement("span");
        fileNameSpan.textContent = filename;

        const descInput = document.createElement("input");
        descInput.type = "text";
        descInput.placeholder = "Description (optional)";
        descInput.value = description;
        descInput.oninput = () => {
          fileObj[filename].description = descInput.value;
        };

        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove";
        removeBtn.className = "remove-file";
        removeBtn.onclick = () => {
          attachedFiles.splice(index, 1);
          renderAttachedFiles();
        };

        div.appendChild(fileNameSpan);
        div.appendChild(descInput);
        div.appendChild(removeBtn);
        attachedFilesContainer.appendChild(div);
      });

      // If more than 3 files, scroll
      if (attachedFiles.length > 3) {
        attachedFilesContainer.style.maxHeight = "120px";
        attachedFilesContainer.style.overflowY = "auto";
      } else {
        attachedFilesContainer.style.maxHeight = "none";
        attachedFilesContainer.style.overflowY = "visible";
      }
    }

    function setFileAttachmentsEditable(isEditable) {
      const addButton = document.getElementById("add_file_btn");
      const attachedFilesContainer = document.getElementById("attached_files_container");

      if (isEditable) {
        addButton.style.display = "inline-block";
      } else {
        addButton.style.display = "none";
      }

      // Re-render
      attachedFilesContainer.innerHTML = "";
      if (isEditable) {
        // Show each file as editable
        attachedFiles.forEach((fileObj, index) => {
          const filename = Object.keys(fileObj)[0];
          const description = fileObj[filename].description;

          const div = document.createElement("div");
          div.className = "file-item";

          const fileNameSpan = document.createElement("span");
          fileNameSpan.textContent = filename;

          const descInput = document.createElement("input");
          descInput.type = "text";
          descInput.placeholder = "Description (optional)";
          descInput.value = description;
          descInput.oninput = () => {
            fileObj[filename].description = descInput.value;
          };

          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Remove";
          removeBtn.className = "remove-file";
          removeBtn.onclick = () => {
            attachedFiles.splice(index, 1);
            setFileAttachmentsEditable(true);
          };

          div.appendChild(fileNameSpan);
          div.appendChild(descInput);
          div.appendChild(removeBtn);
          attachedFilesContainer.appendChild(div);
        });
      } else {
        // Create expandable container
        const expandableDiv = document.createElement("div");
        expandableDiv.className = "expandable-files";

        // Create header with toggle button
        const headerDiv = document.createElement("div");
        headerDiv.className = "expandable-header";
        headerDiv.style.cursor = "pointer";
        headerDiv.style.padding = "8px";
        headerDiv.style.backgroundColor = "#2f2f2f";
        headerDiv.style.borderRadius = "4px";
        headerDiv.style.marginBottom = "5px";
        headerDiv.style.display = "flex";
        headerDiv.style.alignItems = "center";

        const toggleIcon = document.createElement("span");
        toggleIcon.textContent = "▶";
        toggleIcon.style.marginRight = "8px";
        toggleIcon.style.transition = "transform 0.2s";

        const headerText = document.createElement("span");
        headerText.textContent = `Attached Files (${attachedFiles.length})`;

        headerDiv.appendChild(toggleIcon);
        headerDiv.appendChild(headerText);

        // Create content container
        const contentDiv = document.createElement("div");
        contentDiv.style.display = "none";
        contentDiv.style.transition = "max-height 0.2s";
        contentDiv.style.overflow = "hidden";

        // Show files or no files message
        if (attachedFiles.length === 0) {
          const noFilesDiv = document.createElement("div");
          noFilesDiv.style.fontSize = "0.9em";
          noFilesDiv.style.color = "#999";
          noFilesDiv.style.margin = "8px 0";
          noFilesDiv.textContent = "No files attached.";
          contentDiv.appendChild(noFilesDiv);
        } else {
          attachedFiles.forEach((fileObj) => {
            const filename = Object.keys(fileObj)[0];
            const description = fileObj[filename].description;

            const div = document.createElement("div");
            div.className = "file-item static-file";

            const fileLine = document.createElement("div");
            fileLine.style.marginBottom = "4px";

            const fileNameSpan = document.createElement("span");
            fileNameSpan.textContent = filename;
            fileNameSpan.style.color = "#ccc";

            const descSpan = document.createElement("span");
            descSpan.textContent = description ? ` - ${description}` : "";
            descSpan.style.color = "#999";

            fileLine.appendChild(fileNameSpan);
            fileLine.appendChild(descSpan);
            div.appendChild(fileLine);
            contentDiv.appendChild(div);
          });
        }

        // Add toggle functionality
        headerDiv.onclick = () => {
          const isExpanded = contentDiv.style.display === "block";
          contentDiv.style.display = isExpanded ? "none" : "block";
          toggleIcon.style.transform = isExpanded ? "rotate(0deg)" : "rotate(90deg)";
          // Apply scrolling if more than 3 files
          if (!isExpanded && attachedFiles.length > 3) {
            contentDiv.style.maxHeight = "120px";
            contentDiv.style.overflowY = "auto";
          }
        };

        expandableDiv.appendChild(headerDiv);
        expandableDiv.appendChild(contentDiv);
        attachedFilesContainer.appendChild(expandableDiv);
      }

      // Apply the same scroll logic
      if (attachedFiles.length > 3) {
        attachedFilesContainer.style.maxHeight = "120px";
        attachedFilesContainer.style.overflowY = "auto";
      } else {
        attachedFilesContainer.style.maxHeight = "none";
        attachedFilesContainer.style.overflowY = "visible";
      }
    }

    function startAgent() {
      if (eventSource) eventSource.close();
      if (agentRunning) return;

      document.getElementById("user_query").disabled = true;
      // Once we start agent, attachments become read-only
      setFileAttachmentsEditable(false);

      startTime = Date.now();
      if (timerInterval) clearInterval(timerInterval);
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);

      const mode = document.getElementById("mode_select").value;
      let modeParams = {};
      if (mode === "ollama") {
        const ip = document.getElementById("ollama_ip").value;
        const port = document.getElementById("ollama_port").value;
        const model = document.getElementById("ollama_model").value;
        localStorage.setItem("ollama_ip", ip);
        localStorage.setItem("ollama_port", port);
        localStorage.setItem("ollama_model", model);
        modeParams = {
          ollama_ip: ip,
          ollama_port: port,
          ollama_model: model,
        };
      } else {
        const apiKey = document.getElementById("chatgpt_api_key").value;
        const model = document.getElementById("chatgpt_model").value;
        localStorage.setItem("chatgpt_api_key", apiKey);
        localStorage.setItem("chatgpt_model", model);
        modeParams = {
          chatgpt_api_key: apiKey,
          chatgpt_model: model,
        };
      }

      const query = document.getElementById("user_query").value;
      document.getElementById("output_area").textContent = "Starting agent...\n";

      const filesData = attachedFiles.map((f) => f);
      const filesJson = JSON.stringify(filesData);

      const chainArg = activeChainId ? activeChainId : "None";
      const params = new URLSearchParams({
        user_query: query,
        mode: mode,
        ...modeParams,
        attached_files: filesJson,
        chain_id: chainArg,
      }).toString();

      eventSource = new EventSource("/run_agent?" + params, { withCredentials: true });

      eventSource.onmessage = (e) => {
        if (e.data === "[DONE]") {
          eventSource.close();
          eventSource = null;
          document.getElementById("output_area").textContent += "\nAgent finished.\n";
          if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
          }
          showStartButton();
          hideMainProgressBar();
          agentRunning = false;

          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
        } else {
          document.getElementById("output_area").textContent += e.data + "\n";
          const output = document.getElementById("output_area");
          output.scrollTop = output.scrollHeight;
        }
      };

      agentRunning = true;
      if (!agentEverStarted) agentEverStarted = true;
      updateStartButtonLabel();
      showStopButton();
      showMainProgressBar();

      // Poll for new conversation (i.e. a new chain) if chainArg was "None"
      if (conversationInterval) clearInterval(conversationInterval);
      conversationInterval = setInterval(checkForNewConversation, 1000);

      renderPlanStepsPlaceholder();

      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(fetchProgress, 1000);
      fetchProgress();
    }

    function checkForNewConversation() {
      fetch("/latest_conversations")
        .then((res) => res.json())
        .then((convs) => {
          const currentIds = getCurrentConversationIds();
          let foundNew = false;

          for (let c of convs) {
            if (
              !initialConversations.includes(String(c.id)) &&
              !currentIds.includes(String(c.id))
            ) {
              const nowStr = new Date().toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
              addConversationToSidebar(c.id, `New chat ${nowStr}`);
              initialConversations.push(String(c.id));
              activeChainId = c.id;

              // Start plan polling, fetch attached files, rename folder
              startPlanPolling();
              pollChainTitle();
              fetchAttachedFiles(c.id);

              if (!folderRenamed && c.id !== "None") {
                renameNoneFolderTo(c.id);
                folderRenamed = true;
              }


              foundNew = true;
            }
          }

          if (foundNew) {
            clearInterval(conversationInterval);
            conversationInterval = null;
          }
        })
        .catch((err) => console.error(err));
    }

    function renameNoneFolderTo(newId) {
      fetch("/rename_upload_folder", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          old_folder: "None",
          new_folder: newId,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          // no special UI needed
          console.log("Rename folder result:", data);
        })
        .catch((err) => console.error("Rename folder error:", err));
    }

    function addConversationToSidebar(chain_id, title) {
      const container = document.getElementById("conversations_list");
      const div = document.createElement("div");
      div.className = "conversation-item";
      div.setAttribute("data-chain-id", chain_id);

      const titleDiv = document.createElement("div");
      titleDiv.className = "conversation-title";
      titleDiv.textContent = `${title} | ${chain_id}`;
      titleDiv.onclick = () => {
        loadConversation(chain_id);
        activeChainId = chain_id;
        startPlanPolling();
        pollChainTitle();

        if (progressInterval) clearInterval(progressInterval);
        progressInterval = setInterval(fetchProgress, 1000);
        fetchProgress();
      };

      const deleteDiv = document.createElement("div");
      deleteDiv.className = "delete-conversation";
      deleteDiv.textContent = "🗑️";
      deleteDiv.onclick = (ev) => promptDeleteConversation(ev, chain_id);

      div.appendChild(titleDiv);
      div.appendChild(deleteDiv);
      container.insertBefore(div, container.firstChild);
    }

    function fetchAttachedFiles(chain_id) {
      fetch("/get_conversation", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ id: chain_id }),
      })
        .then((response) => response.json())
        .then((data) => {
          const attachedFilesData = JSON.parse(data.attached_files);
          attachedFiles = attachedFilesData.map((fileObj) => fileObj);
          setFileAttachmentsEditable(false);
        })
        .catch((err) => {
          console.error("Error fetching attached files:", err);
        });
    }

    function pollChainTitle() {
      if (!activeChainId) return;
      if (titleInterval) clearInterval(titleInterval);

      titleInterval = setInterval(() => {
        fetch(`/get_title?chain_id=${activeChainId}`)
          .then((res) => res.json())
          .then((data) => {
            if (data.title && data.title.trim().length > 0) {
              updateSidebarTitle(activeChainId, data.title);
              document.getElementById("conversation_title").textContent = data.title;
              clearInterval(titleInterval);
              titleInterval = null;
            }
          })
          .catch((err) => console.error(err));
      }, 1000);
    }

    function updateSidebarTitle(chain_id, realTitle) {
      const item = document.querySelector(`.conversation-item[data-chain-id='${chain_id}']`);
      if (item) {
        const titleDiv = item.querySelector(".conversation-title");
        if (titleDiv) {
          titleDiv.textContent = `${realTitle} | ${chain_id}`;
        }
      }
    }

    function stopAgent() {
      if (!agentRunning) return;
      fetch("/stop_agent", { method: "POST" })
        .then((res) => res.json())
        .then((data) => {
          if (data.status === "stopped") {
            document.getElementById("output_area").textContent +=
              "\nAgent stopped by user.\n";
            if (eventSource) {
              eventSource.close();
              eventSource = null;
            }
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }
            showStartButton();
            hideMainProgressBar();
            agentRunning = false;

            if (progressInterval) {
              clearInterval(progressInterval);
              progressInterval = null;
            }
          }
        });
    }

    function stopAgentIfRunning() {
      if (agentRunning) {
        stopAgent();
      }
    }

    function showMainProgressBar() {
      const bar = document.getElementById("main_progress_bar");
      if (bar) bar.style.display = "block";
    }

    function hideMainProgressBar() {
      const bar = document.getElementById("main_progress_bar");
      if (bar) bar.style.display = "none";
    }

    function showStartButton() {
      document.getElementById("start_agent_btn").style.display = "inline-block";
      document.getElementById("stop_agent_btn").style.display = "none";
    }

    function showStopButton() {
      document.getElementById("start_agent_btn").style.display = "none";
      document.getElementById("stop_agent_btn").style.display = "inline-block";
    }

    function resetTimer() {
      document.getElementById("timer_value").textContent = "00:00:00";
      startTime = null;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function loadConversation(id) {
      // We do NOT close or re-init SSE here; let SSE remain if it is actively streaming.
      fetch("/get_conversation", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ id: id }),
      })
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("output_area").textContent =
            data.history || "No history found.";
          document.getElementById("user_query").value = data.user_query || "";
          document.getElementById("user_query").disabled = true;

          activeChainId = id;
          pollChainTitle();
          startPlanPolling();

          agentEverStarted = true;
          updateStartButtonLabel();

          const attachedFilesData = JSON.parse(data.attached_files);
          attachedFiles = attachedFilesData.map((fileObj) => fileObj);
          setFileAttachmentsEditable(false);

          // Poll progress
          if (progressInterval) clearInterval(progressInterval);
          progressInterval = setInterval(fetchProgress, 1000);
          fetchProgress();
        });
    }

    function promptDeleteConversation(event, id) {
      event.stopPropagation();
      chainIdToDelete = id;
      openDeleteModal();
    }

    function openDeleteModal() {
      const modal = document.getElementById("delete_modal");
      modal.classList.add("active");
    }

    function closeDeleteModal() {
      const modal = document.getElementById("delete_modal");
      modal.classList.remove("active");
      chainIdToDelete = null;
    }

    function deleteConversationConfirmed() {
      if (!chainIdToDelete) return;
      fetch("/delete_conversation", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ id: chainIdToDelete }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.status === "deleted") {
            const item = document.querySelector(
              `.conversation-item[data-chain-id='${chainIdToDelete}']`
            );
            if (item) item.remove();
            initialConversations = initialConversations.filter(
              (cid) => cid !== String(chainIdToDelete)
            );

            if (activeChainId === chainIdToDelete) {
              renderPlanSteps([]);
              activeChainId = null;
              document.getElementById("results_list").innerHTML = "";
              document.getElementById("conversation_title").textContent = "";
              resetProgressIndicators();
            }
          }
          closeDeleteModal();
        })
        .catch(() => {
          closeDeleteModal();
        });
    }

    function updateTimer() {
      if (!startTime) return;
      const elapsed = Date.now() - startTime;
      const hrs = Math.floor(elapsed / 3600000);
      const mins = Math.floor((elapsed % 3600000) / 60000);
      const secs = Math.floor((elapsed % 60000) / 1000);

      const hh = String(hrs).padStart(2, "0");
      const mm = String(mins).padStart(2, "0");
      const ss = String(secs).padStart(2, "0");

      document.getElementById("timer_value").textContent = `${hh}:${mm}:${ss}`;
    }

    /* PLAN STEPS SIDEBAR */
    function startPlanPolling() {
      if (planInterval) clearInterval(planInterval);
      if (activeChainId) {
        planInterval = setInterval(fetchPlanSteps, 1000);
        fetchPlanSteps();
      }
      refreshResults();
    }

    function fetchPlanSteps() {
      if (!activeChainId) return;
      fetch(`/get_plan?chain_id=${activeChainId}`)
        .then((res) => res.json())
        .then((data) => {
          if (!data.plan) {
            showAwaitingPlan();
            lastPlanData = null;
            return;
          }

          const plan = data.plan;  // This might have { overview, num_steps, steps }
          if (!plan.num_steps) {
            showAwaitingPlan();
            lastPlanData = plan;
            return;
          }

          lastPlanData = plan;
          renderPlanSteps(plan);
        })
        .catch((err) => console.error(err));
    }

    function showAwaitingPlan() {
      document.getElementById(
        "plan_steps_container"
      ).innerHTML = `<div class="awaiting-plan">Awaiting plan...</div>`;
    }

    function renderPlanSteps(dataObj) {
      const container = document.getElementById("plan_steps_container");
      container.innerHTML = "";

      // 1) If there's an "overview" key, show it first
      if (dataObj.overview) {
        const overviewDiv = document.createElement("div");
        overviewDiv.className = "plan-step";
        overviewDiv.onclick = () => openStepDetail('overview');

        const headerDiv = document.createElement("div");
        headerDiv.className = "plan-step-header";

        const iconSpan = document.createElement("span");
        iconSpan.className = "step-icon";
        iconSpan.textContent = "🌐";

        const titleSpan = document.createElement("span");
        titleSpan.textContent = "Overview";

        headerDiv.appendChild(iconSpan);
        headerDiv.appendChild(titleSpan);
        overviewDiv.appendChild(headerDiv);

        container.appendChild(overviewDiv);
      }

      // 2) Then list the numbered steps
      const { num_steps, steps } = dataObj;
      for (let i = 1; i <= (num_steps || 0); i++) {
        const stepDiv = document.createElement("div");
        stepDiv.className = "plan-step";
        stepDiv.onclick = () => openStepDetail(i);

        const headerDiv = document.createElement("div");
        headerDiv.className = "plan-step-header";

        const iconSpan = document.createElement("span");
        iconSpan.className = "step-icon";

        const step = steps[i];
        if (step) {
          const status = step.status || "pending";
          iconSpan.textContent = getStepIcon(status);

          const text = step.step_title || step.elaboration || "... (awaiting details)";
          const shortText = shortSummary(text, 50);

          const titleSpan = document.createElement("span");
          titleSpan.textContent = `Step ${i}) ${shortText}`;
          headerDiv.appendChild(iconSpan);
          headerDiv.appendChild(titleSpan);
          stepDiv.appendChild(headerDiv);

          if (status === "elaborating" || status === "executing" || status === "debugging") {
            const boldLine = document.createElement("div");
            boldLine.style.fontWeight = "bold";
            if (status === "debugging") {
              boldLine.textContent = "Debugging...";
            } else {
              boldLine.textContent = status === "elaborating" ? "Elaborating..." : "Executing...";
            }
            stepDiv.appendChild(boldLine);

            const bar = document.createElement("div");
            bar.style.height = "6px";
            bar.style.background = "#444";
            bar.style.position = "relative";
            bar.style.borderRadius = "4px";
            bar.style.overflow = "hidden";
            bar.style.marginTop = "5px";

            const fill = document.createElement("div");
            fill.style.position = "absolute";
            fill.style.top = "0";
            fill.style.left = "-100%";
            fill.style.height = "100%";
            fill.style.width = "100%";
            fill.style.borderRadius = "4px";
            fill.style.animation = "slowTravel 4s linear infinite";

            if (status === "debugging") {
              fill.style.background = "#ff8400";
            } else if (status === "elaborating") {
              fill.style.background = "var(--warning-color)";
            } else {
              fill.style.background = "var(--accent-color)";
            }

            bar.appendChild(fill);
            stepDiv.appendChild(bar);
          }
        } else {
          iconSpan.textContent = "🔘";
          const titleSpan = document.createElement("span");
          titleSpan.textContent = `Step ${i}) ... (awaiting title)`;
          headerDiv.appendChild(iconSpan);
          headerDiv.appendChild(titleSpan);
          stepDiv.appendChild(headerDiv);
        }
        container.appendChild(stepDiv);
      }
    }

    function renderPlanStepsPlaceholder() {
      const container = document.getElementById("plan_steps_container");
      container.innerHTML = "";

      const stepDiv = document.createElement("div");
      stepDiv.className = "plan-step";

      const headerDiv = document.createElement("div");
      headerDiv.className = "plan-step-header";

      const iconSpan = document.createElement("span");
      iconSpan.className = "step-icon";
      iconSpan.textContent = "🔘";

      const titleSpan = document.createElement("span");
      titleSpan.textContent = "Step 1) ... (awaiting plan)";

      headerDiv.appendChild(iconSpan);
      headerDiv.appendChild(titleSpan);
      stepDiv.appendChild(headerDiv);
      container.appendChild(stepDiv);
    }

    function getStepIcon(status) {
      switch (status) {
        case "pending":
          return "🔘";
        case "debugging":
          return "🛠️";
        case "executing":
        case "elaborating":
          return "⏳";
        case "elaborated":
          return "⚪️";
        case "completed":
          return "✅";
        default:
          return "🔘";
      }
    }

    function shortSummary(txt, maxLen) {
      if (!txt) return "";
      if (txt.length <= maxLen) return txt;
      return txt.substring(0, maxLen - 3) + "...";
    }

    /* STEP DETAIL POPUP */
    function openStepDetail(stepIndex) {
      // Special check for overview
      if (stepIndex === 'overview') {
        if (lastPlanData && lastPlanData.overview) {
          showStepModal("Overview", lastPlanData.overview);
        } else {
          showStepModal("Overview", "No overview available.");
        }
        return;
      }

      if (!lastPlanData || !lastPlanData.steps || !lastPlanData.steps[stepIndex]) {
        showStepModal(`Step ${stepIndex}`, "No elaboration available.");
        return;
      }

      const stepObj = lastPlanData.steps[stepIndex];
      const stepTitle = stepObj.step_title || `Step ${stepIndex}`;
      const stepElaboration = stepObj.elaboration || "";
      const bodyText = stepElaboration ? stepElaboration : "No elaboration yet.";
      showStepModal(stepTitle, bodyText);
    }

    function showStepModal(title, body) {
      const overlay = document.getElementById("step_detail_overlay");
      overlay.classList.add("active");
      document.getElementById("step_detail_title").textContent = title;

      const modalBox = document.querySelector(".step-detail-box");
      modalBox.style.maxWidth = "700px";
      modalBox.style.width = "95%";

      if (!window.Prism) {
        const prismCSS = document.createElement('link');
        prismCSS.rel = 'stylesheet';
        prismCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css';
        document.head.appendChild(prismCSS);

        const prismScript = document.createElement('script');
        prismScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js';
        document.head.appendChild(prismScript);

        const languages = ['javascript', 'python', 'bash', 'html', 'css', 'json'];
        languages.forEach(lang => {
          const script = document.createElement('script');
          script.src = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-${lang}.min.js`;
          document.head.appendChild(script);
        });
      }

      if (!window.marked) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        script.onload = () => {
          renderMarkdown(body);
        };
        document.head.appendChild(script);
      } else {
        renderMarkdown(body);
      }
    }

    function renderMarkdown(body) {
      marked.setOptions({
        breaks: true,
        highlight: function(code, lang) {
          if (Prism.languages[lang]) {
            return Prism.highlight(code, Prism.languages[lang], lang);
          }
          return code;
        }
      });

      const bodyEl = document.getElementById("step_detail_body");
      bodyEl.style.padding = '20px';
      bodyEl.innerHTML = marked.parse(body);

      const codeBlocks = bodyEl.querySelectorAll('pre code');
      codeBlocks.forEach(block => {
        const pre = block.parentElement;
        pre.style.border = '1px solid #444';
        pre.style.borderRadius = '4px';
        pre.style.padding = '35px 15px 15px 15px';
        pre.style.position = 'relative';
        pre.style.background = '#1e1e1e';

        const copyButton = document.createElement('button');
        copyButton.textContent = 'Copy';
        copyButton.style.position = 'absolute';
        copyButton.style.left = '5px';
        copyButton.style.top = '5px';
        copyButton.style.padding = '3px 8px';
        copyButton.style.background = '#444';
        copyButton.style.border = 'none';
        copyButton.style.borderRadius = '3px';
        copyButton.style.color = '#fff';
        copyButton.style.cursor = 'pointer';
        copyButton.style.fontSize = '12px';

        copyButton.onclick = () => {
          navigator.clipboard.writeText(block.textContent);
          copyButton.textContent = 'Copied!';
          setTimeout(() => {
            copyButton.textContent = 'Copy';
          }, 2000);
        };

        pre.appendChild(copyButton);

        if (block.className) {
          Prism.highlightElement(block);
        }
      });
    }

    function closeStepDetail() {
      const overlay = document.getElementById("step_detail_overlay");
      overlay.classList.remove("active");
      document.getElementById("step_detail_title").textContent = "";
      document.getElementById("step_detail_body").textContent = "";
    }

    /* RESULTS POLLING */
    function refreshResults() {
      if (!activeChainId) return;
      fetch(`/get_results/${activeChainId}`)
        .then((res) => res.json())
        .then((files) => {
          const list = document.getElementById("results_list");
          list.innerHTML = "";
          if (!files || files.length === 0) {
            const li = document.createElement("li");
            li.textContent = "No files found.";
            list.appendChild(li);
          } else {
            files.forEach((file) => {
              const li = document.createElement("li");
              li.textContent = file;
              list.appendChild(li);
            });
          }
        });
    }
    setInterval(refreshResults, 1000);

    /* PROGRESS POLLING */
    function fetchProgress() {
      if (!activeChainId) return;
      fetch(`/get_progress?chain_id=${activeChainId}`)
        .then((res) => res.json())
        .then((data) => {
          const pct = data.progress_pct;
          const stage = data.progress_stage;

          document.getElementById("progress_pct").textContent = `${pct}%`;
          document.getElementById("progress_stage").textContent =
            stage || "Not started";

          const progressFill = document.getElementById("overall_progress_fill");
          progressFill.style.width = `${pct}%`;
        })
        .catch((err) => console.error(err));
    }
  </script>
</body>
</html>